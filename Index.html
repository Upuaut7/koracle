<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Oracular del Alma</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background: linear-gradient(45deg, #1a1a1a, #2c003e); color: #fff; min-height: 100vh; padding: 20px; text-align: center; margin: 0; }
        .container { max-width: 800px; width: 90%; margin: 0 auto; }
        h1, h2, h3 { color: #d4af37; /* Tono dorado */ font-weight: 600; }
        button { background: #4B0082; color: white; border: none; padding: 12px 25px; margin: 10px; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.3s; }
        button:hover { background: #6A0DAD; transform: scale(1.05); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .oracle-choice { background: rgba(0,0,0,0.3); padding: 30px; border-radius: 12px; margin: 20px 0; border: 1px solid #4B0082; }
        .oracle-app { display: none; /* Ocultos por defecto */ }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #d4af37; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .interpretation-content { white-space: pre-wrap; text-align: left; font-family: sans-serif; background-color: rgba(0,0,0,0.5); padding: 20px; border-radius: 8px; border: 1px solid #d4af37; margin-top: 20px; }
        .interpretation-content b { color: #d4af37; }
        .error-message { color: #ff4d4d; font-weight: bold; margin-top: 15px; }
        /* Estilos espec√≠ficos del Tarot */
        .carta { width: 120px; height: 180px; border-radius: 10px; border: 2px solid #d4af37; display: flex; flex-direction: column; align-items: center; justify-content: center; background-size: cover; font-size: 0.8rem; padding: 5px; box-sizing: border-box; }
        .carta.boca-abajo { background: linear-gradient(45deg, #2c003e, #4B0082); color: transparent; }
        #mazo, #cartas-sacadas { display: flex; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap; }
        #conversacion textarea { width: 95%; margin: 0.5rem; background: #333; color: #fff; border: 1px solid #d4af37; border-radius: 5px; padding: 10px;}
        /* Estilos espec√≠ficos del Receptor Num√©rico */
        .numeric-input { width: calc(100% - 24px); padding: 12px; margin-bottom: 20px; border: 1px solid #dddfe2; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .step { border-top: 2px dashed #4B0082; margin-top: 30px; padding-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Portal Oracular del Alma</h1>

        <!-- SECCI√ìN DE BIENVENIDA / HUB PRINCIPAL -->
        <div id="welcomeHub">
            <div class="oracle-choice">
                <h2>Receptor Num√©rico</h2>
                <p>Usa un n√∫mero nacido de tu intuici√≥n para recibir un mensaje de tu Alma, Cuerpo y la Fuerza Creadora.</p>
                <button onclick="showOracle('numeric')">Entrar al Receptor</button>
            </div>
            <div class="oracle-choice">
                <h2>Tarot de la Ley del Uno</h2>
                <p>Realiza una tirada de 3 cartas basada en los arquetipos de la Mente, el Cuerpo y el Esp√≠ritu.</p>
                <button onclick="showOracle('tarot')">Entrar al Tarot</button>
            </div>
        </div>

        <!-- APLICACI√ìN DEL RECEPTOR NUM√âRICO (Oculta) -->
        <div id="numericOracle" class="oracle-app">
            <button onclick="showHub()">‚Üê Volver al Portal</button>
            <h2>Receptor de Mensajes desde el Alma</h2>
            <div class="step">
                <label for="userQuestionNumeric">1. Escribe tu pregunta o intenci√≥n:</label>
                <input type="text" id="userQuestionNumeric" class="numeric-input" placeholder="Ej: ¬øCu√°l es mi prop√≥sito ahora?">
                <label for="bornNumber">2. Deja "nacer" un n√∫mero y escr√≠belo aqu√≠:</label>
                <input type="text" id="bornNumber" class="numeric-input" placeholder="Ej: 13280268">
                <button id="generateButtonNumeric" onclick="getNumericInterpretation()">Obtener Interpretaci√≥n</button>
            </div>
            <div class="spinner" id="loadingSpinnerNumeric"></div>
            <div id="interpretationAreaNumeric" style="display:none;">
                <h3>Interpretaci√≥n de tu Mensaje</h3>
                <div id="synthesisAreaNumeric" class="interpretation-content"></div>
                <button id="showExtendedButtonNumeric" onclick="showExtendedNumeric()" style="display:none; margin-top:20px;">Ver Mensaje Extendido</button>
                <div id="extendedAreaNumeric" class="interpretation-content" style="display:none; margin-top:20px;"></div>
                <div id="errorAreaNumeric" class="error-message" style="display:none;"></div>
            </div>
        </div>

        <!-- APLICACI√ìN DEL TAROT DE LA LEY DEL UNO (Oculta) -->
        <div id="tarotOracle" class="oracle-app">
            <button onclick="showHub()">‚Üê Volver al Portal</button>
            <h2>Tarot de la Ley del Uno</h2>
            <div class="botones">
                <button onclick="iniciarTirada()">Iniciar Tirada</button>
                <button onclick="barajar()" id="btnBarajar" disabled>Barajar</button>
                <button onclick="sacarCartas()" id="btnSacar" disabled>Sacar Cartas</button>
            </div>
            <p id="mensajeTarot"></p>
            <div id="pregunta-consultante"></div>
            <div id="mazo"></div>
            <div id="cartas-sacadas"></div>
            <div class="spinner" id="loadingSpinnerTarot"></div>
            <div id="interpretationAreaTarot" class="interpretation-content" style="display:none;"></div>
            <div id="conversacion" style="display:none;">
                <textarea id="entrada-usuario" rows="4" placeholder="Profundiza en la lectura o haz otra pregunta..."></textarea><br>
                <button onclick="enviarPreguntaUsuario()">Enviar</button>
            </div>
        </div>
    </div>

    <script>
        // --- L√ìGICA DE NAVEGACI√ìN PRINCIPAL ---
        const welcomeHub = document.getElementById('welcomeHub');
        const numericOracle = document.getElementById('numericOracle');
        const tarotOracle = document.getElementById('tarotOracle');

        function showOracle(oracleName) {
            welcomeHub.style.display = 'none';
            if (oracleName === 'numeric') {
                numericOracle.style.display = 'block';
            } else if (oracleName === 'tarot') {
                tarotOracle.style.display = 'block';
            }
        }
        function showHub() {
            welcomeHub.style.display = 'block';
            numericOracle.style.display = 'none';
            tarotOracle.style.display = 'none';
        }

        // --- L√ìGICA DEL RECEPTOR NUM√âRICO ---
        function mulberry32(seed) { /* ... (c√≥digo del generador PRNG, sin cambios) ... */
            return function() {
              var t = seed += 0x6D2B79F5;
              t = Math.imul(t ^ t >>> 15, t | 1);
              t ^= t + Math.imul(t ^ t >>> 7, t | 61);
              return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        async function getNumericInterpretation() {
            const question = document.getElementById('userQuestionNumeric').value;
            const bornNumberInput = document.getElementById('bornNumber').value;
            if (!bornNumberInput || !question) { alert("Por favor, completa ambos campos."); return; }
            const bornNumber = parseInt(bornNumberInput.replace(/[,.]/g, ''));
            if (isNaN(bornNumber) || bornNumber <= 0) { alert("Por favor, introduce un n√∫mero v√°lido."); return; }

            const generateButton = document.getElementById('generateButtonNumeric');
            const loadingSpinner = document.getElementById('loadingSpinnerNumeric');
            const interpretationArea = document.getElementById('interpretationAreaNumeric');
            const errorArea = document.getElementById('errorAreaNumeric');

            generateButton.disabled = true;
            loadingSpinner.style.display = 'block';
            interpretationArea.style.display = 'none';
            errorArea.style.display = 'none';

            let seed = bornNumber > 2147483647 ? bornNumber % 2147483647 : bornNumber;
            if (seed === 0) seed = 1;
            const rng = mulberry32(seed);
            const numSpins = 1000000;
            const frequencies = {};
            for (let i = 0; i < 37; i++) { frequencies[i] = 0; }
            for (let i = 0; i < numSpins; i++) { frequencies[Math.floor(rng() * 37)]++; }
            const sortedFrequencies = Object.entries(frequencies).sort(([, a], [, b]) => a - b);
            const leastFrequent = sortedFrequencies.slice(0, 3).map(item => item[0]);
            const mostFrequent = sortedFrequencies.slice(-3).reverse().map(item => item[0]);

            try {
                const response = await fetch('/.netlify/functions/getInterpretation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'numeric', // Indicamos qu√© or√°culo es
                        question: question,
                        mostFrequent: mostFrequent,
                        leastFrequent: leastFrequent
                    })
                });
                if (!response.ok) { throw new Error(`Error del servidor: ${response.statusText}`); }
                const data = await response.json();
                displayNumericInterpretation(data.interpretation);
            } catch (error) {
                errorArea.textContent = `Ha ocurrido un error. (Detalle: ${error.message})`;
                errorArea.style.display = 'block';
            } finally {
                generateButton.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }
        function displayNumericInterpretation(fullResponse) {
            if (!fullResponse.includes('### S√çNTESIS ###') || !fullResponse.includes('### DESGLOSE ###') || !fullResponse.includes('### CONCLUSI√ìN ###')) {
                document.getElementById('errorAreaNumeric').textContent = "La respuesta de la IA no tiene el formato esperado.";
                document.getElementById('errorAreaNumeric').style.display = 'block';
                return;
            }
            const synthesisPart = fullResponse.split('### S√çNTESIS ###')[1].split('### DESGLOSE ###')[0].trim();
            const extendedPart = fullResponse.split('### DESGLOSE ###')[1].split('### CONCLUSI√ìN ###')[0].trim();
            const conclusionPart = fullResponse.split('### CONCLUSI√ìN ###')[1].trim();
            
            function formatWhatsappToHtml(text) { return text.replace(/\*([^\*]+)\*/g, '<b>$1</b>').replace(/_([^_]+)_/g, '<i>$1</i>').replace(/\n/g, '<br>'); }

            document.getElementById('synthesisAreaNumeric').innerHTML = `<p>${formatWhatsappToHtml(synthesisPart)}</p><br><h3>Conclusi√≥n Final:</h3><p><i>${formatWhatsappToHtml(conclusionPart)}</i></p>`;
            document.getElementById('extendedAreaNumeric').innerHTML = formatWhatsappToHtml(extendedPart);
            
            document.getElementById('extendedAreaNumeric').style.display = 'none';
            document.getElementById('showExtendedButtonNumeric').style.display = 'inline-block';
            document.getElementById('interpretationAreaNumeric').style.display = 'block';
        }
        function showExtendedNumeric() {
            document.getElementById('extendedAreaNumeric').style.display = 'block';
            document.getElementById('showExtendedButtonNumeric').style.display = 'none';
        }

        // --- L√ìGICA DEL TAROT DE LA LEY DEL UNO ---
        const ARCANOS = [ /* ... (pega aqu√≠ el array ARCANOS completo de tu c√≥digo) ... */ ];
        const RELACIONES_RA = { /* ... (pega aqu√≠ el objeto RELACIONES_RA completo) ... */ };
        let mazo = [];
        let cartasSacadas = [];
        let preguntaTarot = "";
        let conversacionTarot = [];

        function iniciarTirada() {
            renderizarMazoCompleto();
            document.getElementById('mazo').style.display = 'flex';
            preguntaTarot = prompt("¬øCu√°l es tu pregunta para el Tarot?");
            if (preguntaTarot === null || preguntaTarot.trim() === "") {
                preguntaTarot = "Pregunta general sobre mi situaci√≥n actual.";
            }
            document.getElementById('pregunta-consultante').innerHTML = `<p><strong>Pregunta:</strong> ${preguntaTarot}</p>`;
            mazo = [...ARCANOS];
            cartasSacadas = [];
            document.getElementById('btnBarajar').disabled = false;
            document.getElementById('btnSacar').disabled = true;
            document.getElementById('interpretationAreaTarot').style.display = 'none';
            document.getElementById('mensajeTarot').textContent = 'Mazo listo. ¬°Baraja!';
            document.getElementById('conversacion').style.display = 'none';
            conversacionTarot = []; // Reiniciar historial
        }
        function barajar() {
            for (let i = mazo.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [mazo[i], mazo[j]] = [mazo[j], mazo[i]]; }
            document.getElementById('btnSacar').disabled = false;
            document.getElementById('mensajeTarot').textContent = 'Mazo barajado. Saca 3 cartas.';
            renderizarMazoCompleto();
        }
        function sacarCartas() {
            if (mazo.length < 3) return;
            cartasSacadas = mazo.splice(0, 3);
            document.getElementById('mazo').style.display = 'none';
            renderizarCartasSacadas();
            document.getElementById('loadingSpinnerTarot').style.display = 'block';
            document.getElementById('btnSacar').disabled = true;
            document.getElementById('interpretationAreaTarot').innerHTML = ''; // Limpiar interpretaciones previas
            enviarPreguntaUsuario(true); // true para indicar que es la primera pregunta
        }
        function renderizarMazoCompleto() {
            const contenedor = document.getElementById('mazo');
            contenedor.innerHTML = '';
            ARCANOS.forEach((carta) => {
                const div = document.createElement('div');
                div.className = 'carta boca-abajo';
                div.innerHTML = `<span>${carta.nombre}</span>`;
                contenedor.appendChild(div);
            });
        }
        function renderizarCartasSacadas() {
            const contenedor = document.getElementById('cartas-sacadas');
            contenedor.innerHTML = '';
            cartasSacadas.forEach(carta => {
                const div = document.createElement('div');
                div.className = 'carta';
                let simbolo = carta.grupo === 'Mente' ? 'üß†' : carta.grupo === 'Cuerpo' ? 'üå±' : carta.grupo === 'Esp√≠ritu' ? '‚ú®' : '‚ôæÔ∏è';
                div.innerHTML = `<h4>${carta.nombre}</h4><p style="font-size: 2rem;">${simbolo}</p><small>${carta.grupo}</small>`;
                contenedor.appendChild(div);
            });
        }
        async function enviarPreguntaUsuario(esPrimeraPregunta = false) {
            const loadingSpinner = document.getElementById('loadingSpinnerTarot');
            const interpretationArea = document.getElementById('interpretationAreaTarot');
            const conversacionDiv = document.getElementById('conversacion');
            const userInput = document.getElementById('entrada-usuario');
            
            let prompt;
            if (esPrimeraPregunta) {
                const [mente, cuerpo, espiritu] = cartasSacadas;
                prompt = `Eres una maga gitana experta en el Tarot, calida por la templanza de la edad, con un profundo conocimiento de la Ley del Uno (especialmente el Libro IV). Interpreta la siguiente tirada de tres cartas *en relaci√≥n con la pregunta del consultante*. S√© m√≠stica, profunda, usa met√°foras elaboradas, y haz referencias a los conceptos de la Ley del Uno (mente/cuerpo/esp√≠ritu, arquetipos, el Loco como integrador, etc.). Cita textualmente fragmentos relevantes del Libro IV de la Ley del Uno siempre que sea posible.

Pregunta del consultante: ${preguntaTarot}

Las cartas son:
- Carta 1 (Mente): ${mente.nombre} - ${mente.descripcionRa}
- Carta 2 (Cuerpo): ${cuerpo.nombre} - ${cuerpo.descripcionRa}
- Carta 3 (Esp√≠ritu): ${espiritu.nombre} - ${espiritu.descripcionRa}

Ofrece una interpretaci√≥n que incluya:
1.  **An√°lisis individual de cada carta:** Profundiza en su significado en el contexto de la Ley del Uno y la pregunta.
2.  **Relaciones entre las cartas:** Explica c√≥mo interact√∫an las energ√≠as (Mente -> Cuerpo, Cuerpo -> Esp√≠ritu, Esp√≠ritu -> Mente).
3.  **El Rol del Loco:** Incluye una secci√≥n sobre c√≥mo El Loco integra la tirada.
4.  **Consejo o Reflexi√≥n Final:** Ofrece una conclusi√≥n que responda directamente a la pregunta.

Responde en formato HTML usando <h3>, <h4>, <p>, <em> y <br>.`;
                conversacionTarot.push({ role: "user", parts: [{ text: prompt }] });
            } else {
                const preguntaUsuario = userInput.value;
                if (!preguntaUsuario || preguntaUsuario.trim() === "") { alert("Escribe tu pregunta."); return; }
                interpretationArea.innerHTML += `<p><b>T√∫:</b> ${preguntaUsuario}</p>`;
                conversacionTarot.push({ role: "user", parts: [{ text: preguntaUsuario }] });
                userInput.value = '';
            }

            loadingSpinner.style.display = 'block';

            try {
                const response = await fetch('/.netlify/functions/getInterpretation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'tarot', // Indicamos qu√© or√°culo es
                        conversation: conversacionTarot
                    })
                });
                if (!response.ok) { throw new Error(`Error del servidor: ${await response.text()}`); }
                const data = await response.json();
                const interpretacion = data.interpretation;
                conversacionTarot.push({ role: "model", parts: [{ text: interpretacion }] });
                interpretationArea.innerHTML += interpretacion;
                interpretationArea.style.display = 'block';
                if (esPrimeraPregunta) { conversacionDiv.style.display = 'block'; }
            } catch (error) {
                interpretationArea.innerHTML += `<p class="error-message">Error: ${error.message}</p>`;
                interpretationArea.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
    </script>
</body>
</html>
